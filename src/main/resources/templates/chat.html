<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>주간보고 생성기</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', sans-serif; background: #1a1a2e; color: #eee; height: 100vh; display: flex; flex-direction: column; }

        /* header */
        .header { background: #16213e; padding: 16px 24px; display: flex; align-items: center; gap: 12px; border-bottom: 1px solid #0f3460; }
        .header h1 { font-size: 18px; font-weight: 600; }
        .header select { background: #0f3460; color: #eee; border: 1px solid #533483; border-radius: 6px; padding: 6px 10px; font-size: 13px; }

        /* chat area */
        .chat { flex: 1; overflow-y: auto; padding: 20px 24px; display: flex; flex-direction: column; gap: 12px; }
        .msg { max-width: 75%; padding: 12px 16px; border-radius: 16px; font-size: 14px; line-height: 1.6; white-space: pre-wrap; word-break: break-word; }
        .msg.user { align-self: flex-end; background: #533483; border-bottom-right-radius: 4px; }
        .msg.bot { align-self: flex-start; background: #16213e; border: 1px solid #0f3460; border-bottom-left-radius: 4px; }
        .msg.bot .label { font-size: 11px; color: #888; margin-bottom: 4px; }
        .msg.error { border-color: #e74c3c; }
        .msg .report-text { background: #0d1b2a; padding: 12px; border-radius: 8px; margin-top: 8px; font-size: 13px; }
        .msg .report-actions { margin-top: 8px; display: flex; gap: 6px; }
        .msg .report-actions button { background: #0f3460; color: #ccc; border: 1px solid #533483; border-radius: 6px; padding: 4px 12px; font-size: 12px; cursor: pointer; transition: all .2s; }
        .msg .report-actions button:hover { background: #533483; color: #fff; }
        .msg .edit-area { margin-top: 8px; }
        .msg .edit-area textarea { width: 100%; min-height: 200px; background: #0d1b2a; color: #eee; border: 1px solid #533483; border-radius: 8px; padding: 12px; font-size: 13px; font-family: inherit; resize: vertical; line-height: 1.6; }
        .msg .edit-area textarea:focus { outline: none; border-color: #a855f7; }
        .typing { align-self: flex-start; color: #888; font-size: 13px; padding: 8px 16px; }
        .typing::after { content: '...'; animation: dots 1s steps(3) infinite; }
        @keyframes dots { 0% { content: '.'; } 33% { content: '..'; } 66% { content: '...'; } }

        /* quick actions */
        .actions { padding: 8px 24px; display: flex; gap: 8px; flex-wrap: wrap; }
        .actions button { background: #0f3460; color: #ccc; border: 1px solid #533483; border-radius: 20px; padding: 6px 14px; font-size: 12px; cursor: pointer; transition: all .2s; }
        .actions button:hover { background: #533483; color: #fff; }

        /* input area */
        .input-area { background: #16213e; padding: 16px 24px; border-top: 1px solid #0f3460; display: flex; gap: 10px; }
        .input-area textarea { flex: 1; background: #0f3460; color: #eee; border: 1px solid #533483; border-radius: 12px; padding: 12px 16px; font-size: 14px; resize: none; height: 48px; font-family: inherit; }
        .input-area textarea:focus { outline: none; border-color: #a855f7; }
        .input-area button { background: #533483; color: #fff; border: none; border-radius: 12px; padding: 0 20px; font-size: 14px; cursor: pointer; transition: background .2s; }
        .input-area button:hover { background: #a855f7; }
    </style>
</head>
<body>

<div class="header">
    <h1>Weekly Report</h1>
    <select id="userSelect"><option value="">사용자 선택...</option></select>
    <select id="templateSelect"><option value="">템플릿 선택...</option></select>
</div>

<div class="chat" id="chat"></div>

<div class="actions">
    <button onclick="doAction('users')">사용자 목록</button>
    <button onclick="doAction('templates')">템플릿 목록</button>
    <button onclick="doAction('entries')">내 업무기록</button>
    <button onclick="doAction('generate')">주간보고 생성</button>
    <button onclick="doAction('reports')">내 보고서</button>
</div>

<div class="input-area">
    <textarea id="input" placeholder="업무 내용을 입력하세요... (Shift+Enter: 줄바꿈)" onkeydown="handleKey(event)"></textarea>
    <button onclick="sendEntry()">전송</button>
</div>

<script>
const chat = document.getElementById('chat');
const input = document.getElementById('input');
const userSelect = document.getElementById('userSelect');
const templateSelect = document.getElementById('templateSelect');
const API = '/api';

function addMsg(text, type = 'bot', label = '') {
    const div = document.createElement('div');
    div.className = `msg ${type}`;
    if (label && type === 'bot') {
        div.innerHTML = `<div class="label">${label}</div>${escapeHtml(text)}`;
    } else {
        div.textContent = text;
    }
    chat.appendChild(div);
    chat.scrollTop = chat.scrollHeight;
    return div;
}

function addHtmlMsg(html, label = '') {
    const div = document.createElement('div');
    div.className = 'msg bot';
    div.innerHTML = (label ? `<div class="label">${label}</div>` : '') + html;
    chat.appendChild(div);
    chat.scrollTop = chat.scrollHeight;
}

function showTyping() {
    const div = document.createElement('div');
    div.className = 'typing';
    div.id = 'typing';
    div.textContent = '생성 중';
    chat.appendChild(div);
    chat.scrollTop = chat.scrollHeight;
}
function hideTyping() {
    document.getElementById('typing')?.remove();
}

function escapeHtml(t) {
    const d = document.createElement('div');
    d.textContent = t;
    return d.innerHTML;
}

async function api(method, path, body) {
    const opts = { method, headers: { 'Content-Type': 'application/json' } };
    if (body) opts.body = JSON.stringify(body);
    const res = await fetch(API + path, opts);
    const data = await res.json();
    if (!res.ok) throw new Error(data.message || `Error ${res.status}`);
    return data;
}

// --- Load users & templates ---
async function loadUsers() {
    try {
        const users = await api('GET', '/users');
        userSelect.innerHTML = '<option value="">사용자 선택...</option>';
        users.forEach(u => {
            userSelect.innerHTML += `<option value="${u.id}">${u.name} (${u.department || '-'})</option>`;
        });
    } catch (e) { /* ignore */ }
}
async function loadTemplates() {
    try {
        const tpls = await api('GET', '/templates');
        templateSelect.innerHTML = '<option value="">템플릿 선택...</option>';
        tpls.forEach(t => {
            templateSelect.innerHTML += `<option value="${t.id}">${t.name}</option>`;
        });
    } catch (e) { /* ignore */ }
}

// --- Actions ---
async function doAction(action) {
    const userId = userSelect.value;

    if (action === 'users') {
        try {
            const users = await api('GET', '/users');
            if (users.length === 0) return addMsg('등록된 사용자가 없습니다.');
            const list = users.map(u => `• ${u.name} (${u.email}) - ${u.department || '부서없음'}`).join('\n');
            addMsg(list, 'bot', '사용자 목록');
        } catch (e) { addMsg(e.message, 'bot error'); }

    } else if (action === 'templates') {
        try {
            const tpls = await api('GET', '/templates');
            if (tpls.length === 0) return addMsg('등록된 템플릿이 없습니다.');
            const list = tpls.map(t => `• [${t.id}] ${t.name}${t.department ? ' (' + t.department + ')' : ''}`).join('\n');
            addMsg(list, 'bot', '템플릿 목록');
        } catch (e) { addMsg(e.message, 'bot error'); }

    } else if (action === 'entries') {
        if (!userId) return addMsg('사용자를 먼저 선택하세요.', 'bot');
        try {
            const entries = await api('GET', `/daily-entries?userId=${userId}`);
            if (entries.length === 0) return addMsg('등록된 업무기록이 없습니다.', 'bot');
            const list = entries.map(e => `• [${e.entryDate}] ${e.content}${e.category ? ' #' + e.category : ''}`).join('\n');
            addMsg(list, 'bot', '업무기록');
        } catch (e) { addMsg(e.message, 'bot error'); }

    } else if (action === 'generate') {
        if (!userId) return addMsg('사용자를 먼저 선택하세요.', 'bot');
        const tplId = templateSelect.value;
        if (!tplId) return addMsg('템플릿을 먼저 선택하세요.', 'bot');

        const today = new Date();
        const day = today.getDay();
        const mon = new Date(today); mon.setDate(today.getDate() - (day === 0 ? 6 : day - 1));
        const fri = new Date(mon); fri.setDate(mon.getDate() + 4);
        const fmt = d => d.toISOString().split('T')[0];

        addMsg(`주간보고 생성 요청 (${fmt(mon)} ~ ${fmt(fri)})`, 'user');
        showTyping();
        try {
            const report = await api('POST', '/reports/generate', {
                userId: Number(userId), templateId: Number(tplId),
                weekStart: fmt(mon), weekEnd: fmt(fri)
            });
            hideTyping();
            showReport(report);
        } catch (e) { hideTyping(); addMsg(e.message, 'bot error'); }

    } else if (action === 'reports') {
        if (!userId) return addMsg('사용자를 먼저 선택하세요.', 'bot');
        try {
            const reports = await api('GET', `/reports?userId=${userId}`);
            if (reports.length === 0) return addMsg('생성된 보고서가 없습니다.', 'bot');
            let html = reports.map(r =>
                `<div style="margin-bottom:6px">• <a href="#" onclick="viewReport(${r.id});return false" style="color:#a855f7;text-decoration:underline;cursor:pointer">#${r.id}</a> ${r.weekStart} ~ ${r.weekEnd}</div>`
            ).join('');
            addHtmlMsg(html, '보고서 목록');
        } catch (e) { addMsg(e.message, 'bot error'); }
    }
}

// --- Report view/edit ---
function showReport(report) {
    const id = report.id;
    addHtmlMsg(
        `<div class="report-text" id="report-text-${id}">${escapeHtml(report.rendered || '')}</div>` +
        `<div class="report-actions" id="report-actions-${id}">` +
            `<button onclick="editReport(${id})">수정</button>` +
        `</div>`,
        `주간보고 #${id} (${report.weekStart} ~ ${report.weekEnd})`
    );
}

async function viewReport(id) {
    try {
        const report = await api('GET', `/reports/${id}`);
        showReport(report);
    } catch (e) { addMsg(e.message, 'bot error'); }
}

function editReport(id) {
    const actionsEl = document.getElementById(`report-actions-${id}`);
    if (!actionsEl) return;
    actionsEl.innerHTML =
        `<div class="edit-area"><textarea id="edit-input-${id}" placeholder="수정 지시사항을 입력하세요 (예: 좀 더 간결하게 해줘, 성과 부분을 강조해줘)"></textarea></div>` +
        `<div class="report-actions" style="margin-top:6px">` +
            `<button onclick="saveReport(${id})">AI 수정 요청</button>` +
            `<button onclick="cancelEdit(${id})">취소</button>` +
        `</div>`;
    document.getElementById(`edit-input-${id}`).focus();
}

function cancelEdit(id) {
    const actionsEl = document.getElementById(`report-actions-${id}`);
    if (!actionsEl) return;
    actionsEl.innerHTML = `<button onclick="editReport(${id})">수정</button>`;
}

async function saveReport(id) {
    const ta = document.getElementById(`edit-input-${id}`);
    if (!ta) return;
    const instruction = ta.value.trim();
    if (!instruction) return addMsg('수정 지시사항을 입력하세요.', 'bot');
    addMsg(instruction, 'user');
    cancelEdit(id);
    showTyping();
    try {
        const report = await api('PUT', `/reports/${id}`, { instruction });
        hideTyping();
        showReport(report);
    } catch (e) { hideTyping(); addMsg(e.message, 'bot error'); }
}

// --- Send daily entry ---
async function sendEntry() {
    const text = input.value.trim();
    if (!text) return;
    const userId = userSelect.value;
    if (!userId) return addMsg('사용자를 먼저 선택하세요.', 'bot');

    addMsg(text, 'user');
    input.value = '';
    input.style.height = '48px';

    try {
        const entry = await api('POST', '/daily-entries', {
            userId: Number(userId),
            entryDate: new Date().toISOString().split('T')[0],
            content: text
        });
        addMsg(`업무기록 저장 완료 (${entry.entryDate})`, 'bot', '기록됨');
    } catch (e) {
        addMsg(e.message, 'bot error');
    }
}

function handleKey(e) {
    if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendEntry();
    }
}

// auto-resize textarea
input.addEventListener('input', function() {
    this.style.height = '48px';
    this.style.height = Math.min(this.scrollHeight, 120) + 'px';
});

// init
loadUsers();
loadTemplates();
addMsg('안녕하세요! 주간보고 생성기입니다.\n\n1. 위에서 사용자와 템플릿을 선택하세요\n2. 아래 입력창에 오늘 업무 내용을 입력하세요\n3. "주간보고 생성" 버튼으로 AI 보고서를 만들 수 있습니다', 'bot', '시스템');
</script>

</body>
</html>
